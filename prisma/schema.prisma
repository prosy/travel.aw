// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Trip Models
// ============================================================================

model Trip {
  id          String   @id @default(cuid())
  name        String
  description String?
  startDate   String   // YYYY-MM-DD (date-only, matches contract)
  endDate     String   // YYYY-MM-DD (date-only, matches contract)
  destination String
  status      String   @default("draft") // draft, planned, booked, in_progress, completed, cancelled

  // User ownership (nullable for migration - existing trips have no owner)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  items       TripItem[]
  members     TripMember[]  // Trip collaborators

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model TripItem {
  id                 String   @id @default(cuid())
  tripId             String
  trip               Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  type               String   // flight, hotel, activity, transport, restaurant, other
  title              String
  description        String?
  startDateTime      DateTime
  endDateTime        DateTime?

  // Location (stored as JSON)
  locationName       String?
  locationAddress    String?
  locationLat        Float?
  locationLng        Float?

  confirmationNumber String?
  priceAmount        Float?
  priceCurrency      String?  @default("USD")
  status             String   @default("pending") // pending, confirmed, cancelled

  // Offer details stored as JSON
  offerData          String?  // JSON string of OfferHotel or OfferFlight

  // Citations stored as JSON array
  citationsData      String?  // JSON string of Citation[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([tripId])
  @@index([type])
  @@index([startDateTime])
}

// ============================================================================
// Media Cache
// ============================================================================

model CachedMedia {
  id            String   @id @default(cuid())

  type          String   // image, video, document
  source        String   // wikimedia, unsplash, provider, user, placeholder
  originalUrl   String   @unique
  cachedUrl     String?  // Local/CDN cached URL
  thumbnailUrl  String?

  title         String?
  alt           String?

  // Attribution (stored as JSON)
  attribution   String?  // JSON string of MediaAttribution

  width         Int?
  height        Int?
  mimeType      String?
  fileSize      Int?     // in bytes

  // Cache metadata
  cachedAt      DateTime @default(now())
  expiresAt     DateTime?
  lastAccessed  DateTime @default(now())
  accessCount   Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([source])
  @@index([cachedAt])
}

// ============================================================================
// Email Ingestion
// ============================================================================

model InboundEmail {
  id              String   @id @default(cuid())

  messageId       String   @unique // Email Message-ID header
  from            String
  to              String
  subject         String?

  // Email content
  bodyText        String?
  bodyHtml        String?

  // Parsed travel data (JSON)
  extractedData   String?  // JSON of extracted trip items, offers, etc.
  extractionStatus String  @default("pending") // pending, processing, completed, failed
  extractionError String?

  // Processing metadata
  receivedAt      DateTime
  processedAt     DateTime?

  // Link to created trip items
  linkedTripId    String?

  // Raw email storage
  rawHeaders      String?  // JSON of all headers
  attachments     String?  // JSON array of attachment metadata

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([from])
  @@index([receivedAt])
  @@index([extractionStatus])
}

// ============================================================================
// Offer Cache (optional - for caching external API responses)
// ============================================================================

model OfferCache {
  id            String   @id @default(cuid())

  provider      String   // expedia, booking, amadeus, etc.
  offerType     String   // hotel, flight
  queryHash     String   // Hash of search parameters for deduplication

  // Offer data
  offerData     String   // JSON of the full offer response

  // Cache metadata
  cachedAt      DateTime @default(now())
  expiresAt     DateTime

  // Pricing snapshot
  priceAmount   Float?
  priceCurrency String?

  createdAt     DateTime @default(now())

  @@unique([provider, queryHash])
  @@index([provider])
  @@index([offerType])
  @@index([expiresAt])
}

// ============================================================================
// User & Authentication
// ============================================================================

model User {
  id              String   @id @default(cuid())
  auth0Id         String   @unique  // Auth0 subject (sub) claim
  email           String   @unique
  emailVerified   Boolean  @default(false)
  name            String?
  picture         String?  // Profile picture URL from Auth0

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastLoginAt     DateTime?

  // Relations
  trips             Trip[]
  pointsAccounts    PointsAccount[]
  travelDocs        TravelDoc[]
  emergencyContacts EmergencyContact[]
  tripMemberships   TripMember[]
  friendships       Friendship[] @relation("UserFriendships")
  friendOf          Friendship[] @relation("FriendOfUser")
  settings          UserSettings?
  alerts            UserAlert[]
  supportTickets    SupportTicket[]

  @@index([auth0Id])
  @@index([email])
}

model UserSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification preferences
  emailNotifications  Boolean  @default(true)
  pushNotifications   Boolean  @default(false)
  tripReminders       Boolean  @default(true)
  priceAlerts         Boolean  @default(true)

  // Display preferences
  timezone            String   @default("America/New_York")
  dateFormat          String   @default("MM/DD/YYYY")
  currency            String   @default("USD")

  // Connected apps (JSON)
  connectedApps       String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// ============================================================================
// Points Tracker
// ============================================================================

model PointsAccount {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  programType     String   // airline, hotel, credit_card, other
  programName     String   // "Delta SkyMiles", "Marriott Bonvoy", etc.
  accountNumber   String?  // Encrypted
  membershipTier  String?  // Gold, Platinum, etc.

  currentBalance  Int      @default(0)
  pendingPoints   Int      @default(0)
  expiringPoints  Int?
  expirationDate  DateTime?

  // For credit cards
  annualFee       Float?
  nextFeeDate     DateTime?

  notes           String?

  transactions    PointsTransaction[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([programType])
}

model PointsTransaction {
  id              String   @id @default(cuid())
  accountId       String
  account         PointsAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  type            String   // earned, redeemed, transferred, expired, adjustment
  amount          Int
  description     String?
  transactionDate DateTime

  // Link to trip item if applicable
  tripItemId      String?

  createdAt       DateTime @default(now())

  @@index([accountId])
  @@index([transactionDate])
}

// ============================================================================
// Travel Friends & Collaboration
// ============================================================================

model Friendship {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserFriendships", fields: [userId], references: [id], onDelete: Cascade)
  friendId  String
  friend    User     @relation("FriendOfUser", fields: [friendId], references: [id], onDelete: Cascade)

  status    String   @default("pending")  // pending, accepted, blocked
  nickname  String?  // Optional nickname for this friend

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
}

model TripMember {
  id              String   @id @default(cuid())
  tripId          String
  trip            Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role            String   @default("viewer")  // owner, editor, viewer
  invitedAt       DateTime @default(now())
  acceptedAt      DateTime?
  invitedByUserId String?

  // Guest info for non-registered users
  guestEmail      String?
  guestName       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

// ============================================================================
// Safety Features
// ============================================================================

model EmergencyContact {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name         String
  relationship String   // spouse, parent, friend, etc.
  phone        String   // Encrypted
  email        String?  // Encrypted
  isPrimary    Boolean  @default(false)

  // Auto-notify settings
  notifyOnTripStart Boolean @default(false)
  notifyOnDelay     Boolean @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model TravelAdvisory {
  id            String   @id @default(cuid())

  countryCode   String   // ISO 3166-1 alpha-2
  countryName   String
  advisoryLevel Int      // 1-4 (exercise normal precautions to do not travel)
  advisoryText  String
  lastUpdated   DateTime
  source        String   // state_dept, cdc, etc.
  sourceUrl     String?

  // Specific hazards (JSON)
  healthRisks     String?
  securityRisks   String?
  entryRequirements String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([countryCode, source])
  @@index([countryCode])
  @@index([advisoryLevel])
}

model UserAlert {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  tripId      String?
  advisoryId  String?

  alertType   String   // advisory_change, weather, flight_status, etc.
  severity    String   // info, warning, urgent
  title       String
  message     String
  actionUrl   String?

  isRead      Boolean  @default(false)
  readAt      DateTime?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================================================
// Travel Documents (Encrypted)
// ============================================================================

model TravelDoc {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type            String   // passport, visa, drivers_license, insurance, vaccination, other
  title           String

  // Encrypted fields (AES-256-GCM)
  encryptedData   String   // JSON blob with all sensitive fields
  encryptionIV    String   // Initialization vector for decryption

  // Non-sensitive metadata (for listing/filtering)
  countryCode     String?  // Issuing country
  expirationDate  DateTime?
  reminderDays    Int      @default(90)  // Days before expiry to remind

  // File attachment (encrypted separately)
  hasAttachment   Boolean  @default(false)
  attachmentType  String?  // image/jpeg, application/pdf

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([expirationDate])
}

// ============================================================================
// Help Center
// ============================================================================

model SupportTicket {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  subject   String
  category  String   // account, trips, billing, technical, other
  priority  String   @default("normal")  // low, normal, high, urgent
  status    String   @default("open")    // open, in_progress, resolved, closed

  messages  SupportMessage[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  resolvedAt  DateTime?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model SupportMessage {
  id         String   @id @default(cuid())
  ticketId   String
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  senderType String   // user, support, system
  message    String
  attachments String? // JSON array of attachment URLs

  createdAt  DateTime @default(now())

  @@index([ticketId])
}

model FaqArticle {
  id             String   @id @default(cuid())

  category       String
  question       String
  answer         String
  searchKeywords String?  // Space-separated keywords for search
  sortOrder      Int      @default(0)
  isPublished    Boolean  @default(true)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([category])
  @@index([isPublished])
}
