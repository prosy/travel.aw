# Agent State

## Session Info
- **Agent:** Codex CLI (GPT-5.2)
- **Branch:** master
- **Started:** 2026-02-23T05:37:15Z
- **Last updated:** 2026-02-23T05:38:07Z

## Current Task
Combine the ecosystem spec review + v1 web app review into a comprehensive PRD; capture next actions for hardening the v1 app.

## Progress
- Completed
  - Reviewed ecosystem spec `Downloads/TRAVEL_ECOSYSTEM_SPEC_v0_2.md` for determinism blockers (IDs, edge directionality, query computability).
  - Reviewed v1 website repo `Projects/travel` (Next.js/Auth0/Prisma/Anthropic) with focus on security, privacy, correctness, and drift.
  - Produced combined PRD and wrote it to `~/Downloads/TRAVEL_aw_COMBINED_PRD_2026-02-23.md`.
  - Identified high-severity gaps: unauthenticated trip items endpoint, public-ish legacy trip exception, unauthenticated inbound email webhook, “encrypted” fields stored plaintext, LLM endpoint returning raw model output on failure, unused middleware/authz drift.

## Blockers
- Repo working tree is dirty (pre-existing): `prisma/schema.prisma` modified; two untracked files under `TASKS/`. Decide whether to discard or commit separately before starting security hardening work.

## Handoff
### Commits (this session)
- 1 commit — Update `.agent_state.md` with PRD + next actions (see `git log -1` for SHA).

### Next actions (priority order)
1. Fix access control in `apps/web/app/api/trips/[id]/items/route.ts` (require auth + membership/ownership).
2. Remove legacy public-access exception in `apps/web/app/api/trips/[id]/route.ts` for `userId=null` trips (policy: not public).
3. Secure `apps/web/app/api/email/inbound/route.ts` with `SENDGRID_SECRET` (shared secret), remove “link to latest trip” behavior, and add payload size limits.
4. Implement real at-rest encryption for Prisma fields marked “Encrypted”:
   - Add IV columns for `EmergencyContact` and `PointsAccount` in `prisma/schema.prisma` + migration.
   - Update safety contacts + points endpoints to encrypt/decrypt and fail closed when `ENCRYPTION_KEY` missing.
5. Harden LLM endpoint `apps/web/app/api/points/parse/route.ts`:
   - Input size limits, strict output validation, remove returning raw model output on parse errors, model via env.
6. Resolve middleware/AuthZ drift:
   - Either implement `apps/web/middleware.ts` (Auth0) or delete unused `apps/web/proxy.ts`.
   - Deduplicate `authz.yml` vs `config/authz.yml` and align CI pnpm version with repo.

### Useful commands
- `cd Projects/travel && pnpm -r build`
- `cd Projects/travel && pnpm lint`
- `cd Projects/travel && pnpm db:generate`
