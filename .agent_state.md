# Agent State — 2026-02-24

## Completed This Session

- WP-3 Query Cookbook — full implementation:
  - `tools/query_ecosystem/lib/types.ts` — EcosystemNode, EcosystemEdge, QueryResult, BfsPath interfaces
  - `tools/query_ecosystem/lib/graph.ts` — JSONL loading, adjacency map builder, secondary indexes, BFS
  - `tools/query_ecosystem/lib/queries.ts` — Q1–Q5 implementations
  - `tools/query_ecosystem/query_cookbook.ts` — CLI: --query N, --all, --fixtures
  - `docs/ecosystem/QUERY_COOKBOOK.md` (A16) — query definitions, formal criteria, verified expected results
- DD-11 resolved: custom adjacency maps, no graphology (59 nodes too small for library)
- All 5 queries verified: Q1 (1 node), Q2 (12 paths), Q3 (6 nodes), Q4 (3 managers), Q5 (7+6, 0 overlap)
- **Track A MVP complete** — WP-0/1/2/3 all done
- B1 (StopCrabs Supabase) resolved: Supabase not used by StopCrabs, likely for travel.aw web app (Auth + Storage)
- M0-B3: Created `prosy/travel-aw-skills` repo with StopCrabs CI gate
  - Analyzed agent prompt, caught 9 issues: wrong story number (B2→B3), wrong config filename (.stopcrabs.yml→stopcrabs.yaml), wrong config schema, wrong CLI flag positions (-c is global not subcommand), wrong --output flag (dir not file), no --rules-dir exists, naive wildcard grep, SARIF overwrite bug, wrong org (travel-aw→prosy)
  - Corrected all issues before implementing
  - Template skill passes clean (exit 0, 1 review finding)
  - Bad test skill blocked (exit 1, 13 findings)
- M0-B4: Travel-specific rules (TRAVEL-001/002/003) implemented in skills repo
  - Analyzed agent prompt, caught 6 issues: non-existent capability codes (C-PAYMENT etc → only C-BOOKING-TXN exists), missing bad-pii/skill.yaml fixture, nonexistent pre-flight files, CHANGED_SKILLS pattern inconsistency, "book" keyword false positives, missing fetch-depth
  - Created `scripts/travel-rules-check.py` with 3 rules (PII, egress, booking confirmation)
  - Created 4 test fixtures (good-skill + 3 bad), test harness — all 4 tests pass
  - Added `travel-rules` CI job (parallel with StopCrabs and manifest validation)
  - Updated SECURITY_POLICY.md and README.md

## Commit SHAs

- `3f89e1c` — feat(wp-3): query cookbook — 5 deterministic MVP queries (travel.aw)
- `b738498` — feat: initialize travel-aw-skills repo with StopCrabs CI gate (prosy/travel-aw-skills)
- `c86e17f` — feat: add travel-specific security rules TRAVEL-001/002/003 (prosy/travel-aw-skills)

## Next Actions

1. **M0-B2 (deferred):** Fork NanoClaw → prosy/nanoclaw (mechanical, non-blocking)
2. **M0 DoD end-to-end test:** Submit a test skill PR to prosy/travel-aw-skills → verify StopCrabs + travel rules + manifest validation all run → CI pass/fail → human review gate
3. **Track B** — V1 web app security hardening (B1–B6 from Combined PRD). Unpause Supabase project when ready.
4. **WP-4 (optional)** — Graph export (Neo4j/CSV, browse UI)

## Open Blockers

- None

## Key Findings

- StopCrabs `-c` config flag is **global** (before subcommand), not a scan option
- StopCrabs `none_of` rules flag ABSENCE of safety patterns — template skills must include `ALLOWED_PATHS`, `ALLOWED_DOMAINS`, `validate_checksum()`, `REQUIRES_USER_CONFIRMATION`
- StopCrabs has no `--rules-dir` flag — custom rules can't be loaded externally, so travel rules are a separate validation step
- Paused Supabase project (festoiadrbantlykemmd) is unrelated to StopCrabs — likely for travel.aw web app Auth/Storage
- Only `C-BOOKING-TXN` exists in locked A5 registry for booking — agent prompt referenced 4 non-existent capability codes
